"use strict";const r="widget-container";document.addEventListener("DOMContentLoaded",async()=>{var e=document.getElementById(r);if(null==e)throw new Error("failed to get element: "+r);var t=await i.load("scripts/config.json");e.appendChild(t.top_elem)});class i{constructor(e){this.colorer_index=0;var t=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div"),l=(t.id=i.WIDGET_DIV_ID,r.id=i.CONTROLS_DIV_ID,o.id=i.COLORER_DIV_ID,e.colorer_params.map(e=>new n(e))),e=this.build_selector(e.selector_label,l),a=this.build_save_buttons();r.appendChild(e),r.appendChild(a),t.appendChild(r),t.appendChild(o),this.top_elem=t,this.colorer_div=o,this.colorers=l,this.set_colorer(this.colorer_index)}static async load(t){let r;try{r=await async function(e){e=await fetch(e),e=await e.json();if(function(e){if(null==e||"object"!=typeof e)return;var t=e.colorer_selector_label,r=e.color_palettes,e=e.colorers;if("string"!=typeof t)return;if(!function(e){if(null==e||"object"!=typeof e)return;for(const t of Object.values(e)){if(!Array.isArray(t))return;for(const r of t)if("string"!=typeof r)return}return 1}(r))return;if(!Array.isArray(e))return;for(const l of e){if(!function(e){if(null==e||"object"!=typeof e)return;var t=e.colorer_name,r=e.colorer_label,o=e.svg_path,l=e.svg_width,a=e.svg_height,e=e.svg_areas;if("string"!=typeof t)return;if("string"!=typeof r)return;if("string"!=typeof o)return;if("number"!=typeof l)return;if("number"!=typeof a)return;if(!Array.isArray(e))return;for(const n of e)if(!function(e){if(null==e||"object"!=typeof e)return;var t=e.area_name,r=e.color_selector_label,o=e.color_palette,e=e.default_color;return"string"==typeof t&&"string"==typeof r&&"string"==typeof o&&"number"==typeof e}(n))return;return 1}(l))return;for(const a of l.svg_areas){var o=r[a.color_palette];if(null==o)return;if(null==o[a.default_color])return}}return 1}(e))return e;throw new Error("invalid config")}(t)}catch(e){throw new Error(`failed to load config: path: ${t}, error: `+e)}t={selector_label:r.colorer_selector_label,colorer_params:r.colorers.map(e=>({name:e.colorer_name,label:e.colorer_label,svg_path:e.svg_path,svg_width:e.svg_width,svg_height:e.svg_height,color_selector_params:e.svg_areas.map(e=>({name:e.area_name,label:e.color_selector_label,checked_index:e.default_color,colors:r.color_palettes[e.color_palette]}))}))};return new i(t)}build_selector(e,r){var t,o,l=document.createElement("div"),a=document.createElement("label");const n=document.createElement("select");l.className=i.CONTROL_DIV_CLASS_NAME,a.textContent=e,n.required=!0;for([t,o]of r.entries()){var s=document.createElement("option");s.value=o.name,s.textContent=o.label,s.selected=t===this.colorer_index,n.appendChild(s)}return n.addEventListener("change",()=>{for(var[e,t]of r.entries())if(t.name===n.value)return void this.set_colorer(e)}),a.appendChild(n),l.appendChild(a),l}build_save_buttons(){var e=document.createElement("div"),t=document.createElement("button"),r=document.createElement("button");return e.className=i.CONTROL_DIV_CLASS_NAME,t.type="button",r.type="button",t.textContent="Save SVG",r.textContent="Save PNG",t.addEventListener("click",()=>{var e;return null==(e=this.colorers[this.colorer_index])?void 0:e.save_svg()}),r.addEventListener("click",()=>{var e;return null==(e=this.colorers[this.colorer_index])?void 0:e.save_png()}),e.appendChild(t),e.appendChild(r),e}set_colorer(e){var t=this.colorers[e];null!=t&&(t.load_svg(),this.colorer_div.replaceChildren(t.top_elem),this.colorer_index=e)}}i.WIDGET_DIV_ID="widget",i.CONTROLS_DIV_ID="controls",i.COLORER_DIV_ID="colorer",i.CONTROL_DIV_CLASS_NAME="control";class n{constructor(e){var t=document.createElement("div"),r=document.createElement("div"),o=document.createElement("dialog"),l=document.createElement("div");o.className=n.SELECTOR_DIALOG_CLASS_NAME,l.className=n.SELECTOR_DIV_CLASS_NAME,o.appendChild(l),t.appendChild(r),t.appendChild(o),this.top_elem=t,this.name=e.name,this.label=e.label,this.svg_div=r,this.svg_params={path:e.svg_path,width:e.svg_width,height:e.svg_height,area_names:e.color_selector_params.map(e=>e.name)},this.selector_dialog=o,this.selector_div=l,this.selectors=e.color_selector_params.map(e=>new a(e))}async load_svg(){if(null==this.svg){try{this.svg=await s.load(this.svg_params)}catch(e){return void console.error(`failed to load svg: path: ${this.svg_params.path}, error: `+e)}this.svg_div.appendChild(this.svg.svg);for(const[r,o]of this.svg.areas.entries()){const l=this.selectors[r];if(null==l)throw new Error("area is missing its color selector");var t=l.get_value();null!=t&&(o.color=t);let e;o.add_event_listener("mouseover",()=>{clearTimeout(e),o.toggle_class_name(n.SVG_AREA_HOVER_CLASS_NAME,!0),e=setTimeout(()=>o.toggle_class_name(n.SVG_AREA_HOVER_CLASS_NAME,!1),n.SVG_AREA_HOVER_TIMEOUT)}),o.add_event_listener("mouseout",()=>{clearTimeout(e),o.toggle_class_name(n.SVG_AREA_HOVER_CLASS_NAME,!1)}),o.add_event_listener("click",e=>{this.selector_div.replaceChildren(l.top_elem),this.selector_dialog.style.top=e.clientY+"px",this.selector_dialog.style.left=e.clientX+"px",this.selector_dialog.showModal()}),l.add_event_listener("click",()=>{var e=l.get_value();null!=e&&(o.color=e),this.selector_dialog.close()}),this.selector_dialog.addEventListener("click",e=>{e.target===this.selector_dialog&&this.selector_dialog.close()})}}}save_svg(){var e;null!=(e=this.svg)&&e.save_svg(this.name+".svg")}save_png(){var e;null!=(e=this.svg)&&e.save_png(this.name+".png")}}n.SELECTOR_DIALOG_CLASS_NAME="color-selector-dialog",n.SELECTOR_DIV_CLASS_NAME="color-selector",n.SVG_AREA_HOVER_CLASS_NAME="svg-area-hover",n.SVG_AREA_HOVER_TIMEOUT=1e4;class s{constructor(t,e){this.svg=t,this.areas=e.area_names.map(e=>new o(t,e)),this.width=e.width,this.height=e.height}static async load(e){var t=await(await fetch(e.path)).text(),r=document.createElement("template"),t=(r.innerHTML=t,r.content.firstElementChild);if("svg"!==(null==t?void 0:t.nodeName))throw new Error("invalid contents");return t.setAttribute("width",e.width.toString()),t.setAttribute("height",e.height.toString()),new s(t,e)}save_svg(e){var t=this.get_blob(),t=URL.createObjectURL(t);s.download(t,e),URL.revokeObjectURL(t)}save_png(t){const e=document.createElement("canvas"),r=(e.width=this.width,e.height=this.height,e.getContext("2d"));if(null!=r){var o=this.get_blob();const l=URL.createObjectURL(o),a=new Image;a.src=l,a.addEventListener("load",()=>{r.drawImage(a,0,0),URL.revokeObjectURL(l),e.toBlob(e=>{null!=e&&(e=URL.createObjectURL(e),s.download(e,t),URL.revokeObjectURL(e))})})}}get_blob(){var e=(new XMLSerializer).serializeToString(this.svg);return new Blob([e],{type:"image/svg+xml;charset=utf-8"})}static download(e,t){var r=document.createElement("a");r.href=e,r.download=t,r.target="_blank",r.click()}}class o{constructor(e,t){var r=[];for(const o of e.getElementsByClassName(t))r.push(o);this.sub_areas=r}set color(e){for(const t of this.sub_areas)t.style.fill=e}toggle_class_name(e,t){for(const r of this.sub_areas)r.classList.toggle(e,t)}add_event_listener(e,t){for(const r of this.sub_areas)r.addEventListener(e,t)}}class a{constructor(e){var t,r,o=[];for([t,r]of e.colors.entries())o.push(new c({name:e.name,color:r,checked:t===e.checked_index,required:!0}));this.top_elem=a.build(e.label,o),this.buttons=o}get_value(){var e;return null==(e=this.buttons.find(e=>e.checked))?void 0:e.value}add_event_listener(e,t){for(const r of this.buttons)r.add_event_listener(e,t)}static build(e,t){var r=document.createElement("fieldset"),o=document.createElement("legend");const l=document.createElement("div");return o.textContent=e,l.className=a.BUTTONS_DIV_CLASS_NAME,t.forEach(e=>l.appendChild(e.top_elem)),r.appendChild(o),r.appendChild(l),r}}a.BUTTONS_DIV_CLASS_NAME="color-buttons";class c{constructor(e){var t=document.createElement("label"),r=document.createElement("input"),o=document.createElement("div"),l=document.createElement("div");t.className=c.CLASS_NAME,r.type="radio",r.name=e.name,r.value=e.color,r.checked=e.checked,r.required=e.required,o.className=c.COLOR_BOX_OUTER_CLASS_NAME,l.className=c.COLOR_BOX_INNER_CLASS_NAME,l.style.backgroundColor=e.color,o.appendChild(l),t.appendChild(r),t.appendChild(o),this.top_elem=t,this.input_elem=r}get checked(){return this.input_elem.checked}get value(){return this.input_elem.value}add_event_listener(e,t){this.input_elem.addEventListener(e,t)}}c.CLASS_NAME="color-button",c.COLOR_BOX_OUTER_CLASS_NAME="color-box-outer",c.COLOR_BOX_INNER_CLASS_NAME="color-box-inner";