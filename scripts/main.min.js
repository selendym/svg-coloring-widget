"use strict";var o=this&&this.__awaiter||function(e,i,a,l){return new(a=a||Promise)(function(r,t){function o(e){try{s(l.next(e))}catch(e){t(e)}}function n(e){try{s(l.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?r(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(o,n)}s((l=l.apply(e,i||[])).next())})};const r="widget-container";document.addEventListener("DOMContentLoaded",()=>o(void 0,void 0,void 0,function*(){var e=document.getElementById(r);if(null==e)throw new Error("failed to get element: "+r);var t=yield l.load("scripts/config.json");e.appendChild(t.top_elem)}));class l{constructor(e){this.colorer_index=0;var t=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div"),e=(t.id=l.WIDGET_DIV_ID,r.id=l.CONTROLS_DIV_ID,o.id=l.COLORER_DIV_ID,e.colorer_params.map(e=>new i(e))),n=this.build_selector("Select colorer: ",e),s=this.build_save_buttons();r.appendChild(n),r.appendChild(s),t.appendChild(r),t.appendChild(o),this.top_elem=t,this.colorer_div=o,this.colorers=e,this.set_colorer(this.colorer_index)}static load(r){return o(this,void 0,void 0,function*(){let e;try{e=yield function(t){return o(this,void 0,void 0,function*(){var e=yield(yield fetch(t)).json();if(function(e){if(null==e||"object"!=typeof e)return;e=e.colorers;if(!Array.isArray(e))return;for(const t of e)if(!function(e){if(null==e||"object"!=typeof e)return;var t=e.name,r=e.svg_path,o=e.svg_width,n=e.svg_height,e=e.svg_areas;if("string"!=typeof t)return;if("string"!=typeof r)return;if("number"!=typeof o)return;if("number"!=typeof n)return;if(!Array.isArray(e))return;for(const s of e)if(!function(e){if(null==e||"object"!=typeof e)return;var t=e.name,e=e.colors;if("string"!=typeof t)return;if(!Array.isArray(e))return;for(const r of e)if("string"!=typeof r)return;return 1}(s))return;return 1}(t))return;return 1}(e))return e;throw new Error("invalid config")})}(r)}catch(e){throw new Error(`failed to load config: path: ${r}, error: `+e)}var t={colorer_params:e.colorers.map(e=>({name:e.name,svg_path:e.svg_path,svg_width:e.svg_width,svg_height:e.svg_height,color_selector_params:e.svg_areas.map(e=>({name:e.name,label:`Select color for ${e.name}:`,colors:e.colors}))}))};return new l(t)})}build_selector(e,r){var t,o,n=document.createElement("div"),s=document.createElement("label");const i=document.createElement("select");n.className=l.CONTROL_DIV_CLASS_NAME,s.textContent=e,i.required=!0;for([t,o]of r.entries()){var a=document.createElement("option");a.value=o.name,a.textContent=o.name,a.selected=t===this.colorer_index,i.appendChild(a)}return i.addEventListener("change",()=>{for(var[e,t]of r.entries())if(t.name===i.value)return void this.set_colorer(e)}),s.appendChild(i),n.appendChild(s),n}build_save_buttons(){var e=document.createElement("div"),t=document.createElement("button"),r=document.createElement("button");return e.className=l.CONTROL_DIV_CLASS_NAME,t.className=l.SAVE_BUTTON_CLASS_NAME,r.className=l.SAVE_BUTTON_CLASS_NAME,t.type="button",r.type="button",t.textContent="Save SVG",r.textContent="Save PNG",t.addEventListener("click",()=>{var e;return null==(e=this.colorers[this.colorer_index])?void 0:e.save_svg()}),r.addEventListener("click",()=>{var e;return null==(e=this.colorers[this.colorer_index])?void 0:e.save_png()}),e.appendChild(t),e.appendChild(r),e}set_colorer(e){var t=this.colorers[e];null!=t&&(t.load_svg(),this.colorer_div.replaceChildren(t.top_elem),this.colorer_index=e)}}l.WIDGET_DIV_ID="widget",l.CONTROLS_DIV_ID="controls",l.COLORER_DIV_ID="colorer",l.CONTROL_DIV_CLASS_NAME="control",l.SAVE_BUTTON_CLASS_NAME="save-button";class i{constructor(e){var t=document.createElement("div"),r=document.createElement("div"),o=document.createElement("dialog"),n=document.createElement("div");o.className=i.SELECTOR_DIALOG_CLASS_NAME,n.className=i.SELECTOR_DIV_CLASS_NAME,o.appendChild(n),t.appendChild(r),t.appendChild(o),this.top_elem=t,this.name=e.name,this.svg_div=r,this.svg_params={path:e.svg_path,width:e.svg_width,height:e.svg_height,area_names:e.color_selector_params.map(e=>e.name)},this.selector_dialog=o,this.selector_div=n,this.selectors=e.color_selector_params.map(e=>new s(e))}load_svg(){return o(this,void 0,void 0,function*(){if(null==this.svg){try{this.svg=yield a.load(this.svg_params)}catch(e){return void console.error(`failed to load svg: path: ${this.svg_params.path}, error: `+e)}this.svg_div.appendChild(this.svg.svg);for(const[r,o]of this.svg.areas.entries()){const n=this.selectors[r];if(null==n)throw new Error("area is missing its color selector");var t=n.get_value();null!=t&&(o.color=t);let e;o.add_event_listener("mouseover",()=>{clearTimeout(e),o.toggle_class_name(i.SVG_AREA_HOVER_CLASS_NAME,!0),e=setTimeout(()=>o.toggle_class_name(i.SVG_AREA_HOVER_CLASS_NAME,!1),i.SVG_AREA_HOVER_TIMEOUT)}),o.add_event_listener("mouseout",()=>{clearTimeout(e),o.toggle_class_name(i.SVG_AREA_HOVER_CLASS_NAME,!1)}),o.add_event_listener("click",e=>{this.selector_div.replaceChildren(n.top_elem),this.selector_dialog.style.top=e.clientY+"px",this.selector_dialog.style.left=e.clientX+"px",this.selector_dialog.showModal()}),n.add_event_listener("click",()=>{var e=n.get_value();null!=e&&(o.color=e),this.selector_dialog.close()}),this.selector_dialog.addEventListener("click",e=>{e.target===this.selector_dialog&&this.selector_dialog.close()})}}})}save_svg(){var e;null!=(e=this.svg)&&e.save_svg(this.name+".svg")}save_png(){var e;null!=(e=this.svg)&&e.save_png(this.name+".png")}}i.SELECTOR_DIALOG_CLASS_NAME="color-selector-dialog",i.SELECTOR_DIV_CLASS_NAME="color-selector",i.SVG_AREA_HOVER_CLASS_NAME="svg-area-hover",i.SVG_AREA_HOVER_TIMEOUT=1e4;class a{constructor(t,e){this.svg=t,this.areas=e.area_names.map(e=>new n(t,e)),this.width=e.width,this.height=e.height}static load(r){return o(this,void 0,void 0,function*(){var e=yield(yield fetch(r.path)).text(),t=document.createElement("template"),e=(t.innerHTML=e,t.content.firstElementChild);if("svg"!==(null==e?void 0:e.nodeName))throw new Error("invalid contents");return e.setAttribute("width",r.width.toString()),e.setAttribute("height",r.height.toString()),new a(e,r)})}save_svg(e){var t=this.get_blob(),t=URL.createObjectURL(t);a.download(t,e),URL.revokeObjectURL(t)}save_png(t){const e=document.createElement("canvas"),r=(e.width=this.width,e.height=this.height,e.getContext("2d"));if(null!=r){var o=this.get_blob();const n=URL.createObjectURL(o),s=new Image;s.src=n,s.addEventListener("load",()=>{r.drawImage(s,0,0),URL.revokeObjectURL(n),e.toBlob(e=>{null!=e&&(e=URL.createObjectURL(e),a.download(e,t),URL.revokeObjectURL(e))})})}}get_blob(){var e=(new XMLSerializer).serializeToString(this.svg);return new Blob([e],{type:"image/svg+xml;charset=utf-8"})}static download(e,t){var r=document.createElement("a");r.href=e,r.download=t,r.target="_blank",r.click()}}class n{constructor(e,t){var r=[];for(const o of e.getElementsByClassName(t))r.push(o);this.sub_areas=r}set color(e){for(const t of this.sub_areas)t.style.fill=e}toggle_class_name(e,t){for(const r of this.sub_areas)r.classList.toggle(e,t)}add_event_listener(e,t){for(const r of this.sub_areas)r.addEventListener(e,t)}}class s{constructor(e){var t,r,o=[];for([t,r]of e.colors.entries())o.push(new c({name:e.name,color:r,checked:0===t,required:!0}));this.top_elem=s.build(e.label,o),this.buttons=o}get_value(){var e;return null==(e=this.buttons.find(e=>e.checked))?void 0:e.value}add_event_listener(e,t){for(const r of this.buttons)r.add_event_listener(e,t)}static build(e,t){var r=document.createElement("fieldset"),o=document.createElement("legend");const n=document.createElement("div");return o.textContent=e,n.className=s.BUTTONS_DIV_CLASS_NAME,t.forEach(e=>n.appendChild(e.top_elem)),r.appendChild(o),r.appendChild(n),r}}s.BUTTONS_DIV_CLASS_NAME="color-buttons";class c{constructor(e){var t=document.createElement("label"),r=document.createElement("input"),o=document.createElement("div"),n=document.createElement("div");t.className=c.CLASS_NAME,r.type="radio",r.name=e.name,r.value=e.color,r.checked=e.checked,r.required=e.required,o.className=c.COLOR_BOX_OUTER_CLASS_NAME,n.className=c.COLOR_BOX_INNER_CLASS_NAME,n.style.backgroundColor=e.color,o.appendChild(n),t.appendChild(r),t.appendChild(o),this.top_elem=t,this.input_elem=r}get checked(){return this.input_elem.checked}get value(){return this.input_elem.value}add_event_listener(e,t){this.input_elem.addEventListener(e,t)}}c.CLASS_NAME="color-button",c.COLOR_BOX_OUTER_CLASS_NAME="color-box-outer",c.COLOR_BOX_INNER_CLASS_NAME="color-box-inner";