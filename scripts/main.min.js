"use strict";const r="widget-container";document.addEventListener("DOMContentLoaded",async()=>{var e=document.getElementById(r);if(null==e)throw new Error("failed to get element: "+r);var t=await s.load("scripts/config.json");e.appendChild(t.top_elem)});class s{constructor(e){this.colorer_index=0;var t=document.createElement("div"),r=document.createElement("div"),l=document.createElement("div"),o=(t.id=s.WIDGET_DIV_ID,r.id=s.CONTROLS_DIV_ID,l.id=s.COLORER_DIV_ID,e.colorer_params.map(e=>new i(e))),e=this.build_selector(e.selector_label,o),n=this.build_save_buttons();r.appendChild(e),r.appendChild(n),t.appendChild(r),t.appendChild(l),this.top_elem=t,this.colorer_div=l,this.colorers=o,this.set_colorer(this.colorer_index)}static async load(t){let r;try{r=await async function(e){e=await fetch(e),e=await e.json();if(function(e){if(null==e||"object"!=typeof e)return;var t=e.colorer_selector_label,r=e.color_palettes,e=e.colorers;if("string"!=typeof t)return;if(!function(e){if(null==e||"object"!=typeof e)return;for(const t of Object.values(e)){if(!Array.isArray(t))return;for(const r of t)if("string"!=typeof r)return}return 1}(r))return;if(!Array.isArray(e))return;for(const o of e){if(!function(e){if(null==e||"object"!=typeof e)return;var t=e.colorer_name,r=e.colorer_label,l=e.svg_path,o=e.svg_width,n=e.svg_height,a=e.svg_font_family,i=e.svg_font_size,s=e.svg_areas,e=e.text_fields;if("string"!=typeof t)return;if("string"!=typeof r)return;if("string"!=typeof l)return;if("number"!=typeof o)return;if("number"!=typeof n)return;if("string"!=typeof a)return;if("number"!=typeof i)return;if(!Array.isArray(s))return;if(!Array.isArray(e))return;for(const c of s)if(!function(e){if(null==e||"object"!=typeof e)return;var t=e.area_name,r=e.color_selector_label,l=e.color_palette,e=e.default_color;return"string"==typeof t&&"string"==typeof r&&"string"==typeof l&&"number"==typeof e}(c))return;for(const _ of e)if(!function(e){if(null==e||"object"!=typeof e)return;var t=e.field_name,r=e.field_label,l=e.required,o=e.min_length,n=e.max_length,a=e.pattern,i=e.placeholder,e=e.spellcheck;return"string"==typeof t&&"string"==typeof r&&!(void 0!==l&&"boolean"!=typeof l||void 0!==o&&"number"!=typeof o||void 0!==n&&"number"!=typeof n||void 0!==a&&"string"!=typeof a||void 0!==i&&"string"!=typeof i||void 0!==e&&"boolean"!=typeof e)}(_))return;return 1}(o))return;for(const n of o.svg_areas){var l=r[n.color_palette];if(null==l)return;if(null==l[n.default_color])return}}return 1}(e))return e;throw new Error("invalid config")}(t)}catch(e){throw new Error(`failed to load config: path: ${t}, error: `+e)}t={selector_label:r.colorer_selector_label,colorer_params:r.colorers.map(e=>({name:e.colorer_name,label:e.colorer_label,svg_path:e.svg_path,svg_width:e.svg_width,svg_height:e.svg_height,svg_font_family:e.svg_font_family,svg_font_size:e.svg_font_size,color_selector_params:e.svg_areas.map(e=>({name:e.area_name,label:e.color_selector_label,checked_index:e.default_color,colors:r.color_palettes[e.color_palette]})),text_field_params:e.text_fields.map(e=>({name:e.field_name,label:e.field_label,required:e.required,min_length:e.min_length,max_length:e.max_length,pattern:e.pattern,placeholder:e.placeholder,spellcheck:e.spellcheck}))}))};return new s(t)}build_selector(e,r){var t,l,o=document.createElement("div"),n=document.createElement("label");const a=document.createElement("select");o.className=s.CONTROL_DIV_CLASS_NAME,n.textContent=e,a.required=!0;for([t,l]of r.entries()){var i=document.createElement("option");i.value=l.name,i.textContent=l.label,i.selected=t===this.colorer_index,a.appendChild(i)}return a.addEventListener("change",()=>{for(var[e,t]of r.entries())if(t.name===a.value)return void this.set_colorer(e)}),n.appendChild(a),o.appendChild(n),o}build_save_buttons(){var e=document.createElement("div"),t=document.createElement("button"),r=document.createElement("button");return e.className=s.CONTROL_DIV_CLASS_NAME,t.type="button",r.type="button",t.textContent="Save SVG",r.textContent="Save PNG",t.addEventListener("click",()=>{var e;return null==(e=this.colorers[this.colorer_index])?void 0:e.save_svg()}),r.addEventListener("click",()=>{var e;return null==(e=this.colorers[this.colorer_index])?void 0:e.save_png()}),e.appendChild(t),e.appendChild(r),e}set_colorer(e){var t=this.colorers[e];null!=t&&(t.load_svg(),this.colorer_div.replaceChildren(t.top_elem),this.colorer_index=e)}}s.WIDGET_DIV_ID="widget",s.CONTROLS_DIV_ID="controls",s.COLORER_DIV_ID="colorer",s.CONTROL_DIV_CLASS_NAME="control";class i{constructor(e){var t=document.createElement("div"),r=document.createElement("div");const l=document.createElement("div");var o=document.createElement("dialog"),n=document.createElement("div"),a=(o.className=i.SELECTOR_DIALOG_CLASS_NAME,n.className=i.SELECTOR_DIV_CLASS_NAME,l.className=i.TEXT_FIELD_DIV_CLASS_NAME,e.text_field_params.map(e=>new _(e)));a.forEach(e=>l.appendChild(e.top_elem)),o.appendChild(n),t.appendChild(r),t.appendChild(l),t.appendChild(o),this.top_elem=t,this.name=e.name,this.label=e.label,this.svg_div=r,this.svg_params={path:e.svg_path,width:e.svg_width,height:e.svg_height,font_family:e.svg_font_family,font_size:e.svg_font_size,area_names:e.color_selector_params.map(e=>e.name)},this.selector_dialog=o,this.selector_div=n,this.selectors=e.color_selector_params.map(e=>new c(e)),this.text_fields=a}async load_svg(){if(null==this.svg){try{this.svg=await a.load(this.svg_params)}catch(e){return void console.error(`failed to load svg: path: ${this.svg_params.path}, error: `+e)}this.svg_div.appendChild(this.svg.svg);for(const[r,l]of this.svg.areas.entries()){const o=this.selectors[r];if(null==o)throw new Error("area is missing its color selector");var t=o.get_value();null!=t&&(l.color=t);let e;l.add_event_listener("mouseover",()=>{clearTimeout(e),l.toggle_class_name(i.SVG_AREA_HOVER_CLASS_NAME,!0),e=setTimeout(()=>l.toggle_class_name(i.SVG_AREA_HOVER_CLASS_NAME,!1),i.SVG_AREA_HOVER_TIMEOUT)}),l.add_event_listener("mouseout",()=>{clearTimeout(e),l.toggle_class_name(i.SVG_AREA_HOVER_CLASS_NAME,!1)}),l.add_event_listener("click",e=>{this.selector_div.replaceChildren(o.top_elem),this.selector_dialog.style.top=e.clientY+"px",this.selector_dialog.style.left=e.clientX+"px",this.selector_dialog.showModal()}),o.add_event_listener("click",()=>{var e=o.get_value();null!=e&&(l.color=e),this.selector_dialog.close()}),this.selector_dialog.addEventListener("click",e=>{e.target===this.selector_dialog&&this.selector_dialog.close()})}}}save_svg(){var e;null!=(e=this.svg)&&e.save_svg(this.name+".svg",this.text_fields)}save_png(){var e;null!=(e=this.svg)&&e.save_png(this.name+".png",this.text_fields)}}i.SELECTOR_DIALOG_CLASS_NAME="color-selector-dialog",i.SELECTOR_DIV_CLASS_NAME="color-selector",i.TEXT_FIELD_DIV_CLASS_NAME="text-fields",i.SVG_AREA_HOVER_CLASS_NAME="svg-area-hover",i.SVG_AREA_HOVER_TIMEOUT=1e4;class a{constructor(t,e){this.svg=t,this.areas=e.area_names.map(e=>new l(t,e)),this.width=e.width,this.height=e.height,this.font_family=e.font_family,this.font_size=e.font_size,this.line_height=1.2*e.font_size}static async load(e){var t=await(await fetch(e.path)).text(),r=document.createElement("template"),t=(r.innerHTML=t,r.content.firstElementChild);if("svg"!==(null==t?void 0:t.nodeName))throw new Error("invalid contents");return t.setAttribute("width",e.width.toString()),t.setAttribute("height",e.height.toString()),new a(t,e)}save_svg(e,t){t=this.get_blob(t),t=URL.createObjectURL(t);a.download(t,e),URL.revokeObjectURL(t)}save_png(t,e){const r=document.createElement("canvas"),l=(r.width=this.width,r.height=this.height,r.getContext("2d"));if(null!=l){e=this.get_blob(e);const o=URL.createObjectURL(e),n=new Image;n.src=o,n.addEventListener("load",()=>{l.drawImage(n,0,0),URL.revokeObjectURL(o),r.toBlob(e=>{null!=e&&(e=URL.createObjectURL(e),a.download(e,t),URL.revokeObjectURL(e))})})}}get_blob(e){var t=this.svg.cloneNode(!0),r=t.viewBox.baseVal.height/this.height,e=this.get_text(e,r),l=document.createElementNS("http://www.w3.org/2000/svg","g"),e=(l.setAttribute("transform",`translate(${t.viewBox.baseVal.x} ${t.viewBox.baseVal.y+t.viewBox.baseVal.height})`),l.appendChild(e),t.appendChild(l),t.style.visibility="hidden",t.style.width="0",t.style.height="0",null!=(e=this.svg.parentElement)&&e.appendChild(t),l.getBBox()),l=(t.viewBox.baseVal.width=Math.max(t.viewBox.baseVal.width,e.width+this.font_size*r*2),t.viewBox.baseVal.height+=e.height+this.line_height*r,t.remove(),t.style.removeProperty("visibility"),t.style.removeProperty("width"),t.style.removeProperty("height"),(new XMLSerializer).serializeToString(t));return new Blob([l],{type:"image/svg+xml;charset=utf-8"})}get_text(e,t){const r=document.createElementNS("http://www.w3.org/2000/svg","text");var l=this.font_size*t;const o=this.line_height*t;return r.style.fontFamily=this.font_family,r.style.fontSize=l+"px",r.setAttribute("x","0"),r.setAttribute("y","0"),e.forEach(e=>{var t=document.createElementNS("http://www.w3.org/2000/svg","tspan");t.textContent=`${e.name}: ${e.value}\n`,t.setAttribute("x","0"),t.setAttribute("dy",o.toString()),r.appendChild(t)}),r}static download(e,t){var r=document.createElement("a");r.href=e,r.download=t,r.target="_blank",r.click()}}class l{constructor(e,t){var r=[];for(const l of e.getElementsByClassName(t))r.push(l);this.sub_areas=r}set color(e){for(const t of this.sub_areas)t.style.fill=e}toggle_class_name(e,t){for(const r of this.sub_areas)r.classList.toggle(e,t)}add_event_listener(e,t){for(const r of this.sub_areas)r.addEventListener(e,t)}}class c{constructor(e){var t,r,l=[];for([t,r]of e.colors.entries())l.push(new n({name:e.name,color:r,checked:t===e.checked_index,required:!0}));this.top_elem=c.build(e.label,l),this.buttons=l}get_value(){var e;return null==(e=this.buttons.find(e=>e.checked))?void 0:e.value}add_event_listener(e,t){for(const r of this.buttons)r.add_event_listener(e,t)}static build(e,t){var r=document.createElement("fieldset"),l=document.createElement("legend");const o=document.createElement("div");return l.textContent=e,o.className=c.BUTTONS_DIV_CLASS_NAME,t.forEach(e=>o.appendChild(e.top_elem)),r.appendChild(l),r.appendChild(o),r}}c.BUTTONS_DIV_CLASS_NAME="color-buttons";class n{constructor(e){var t=document.createElement("label"),r=document.createElement("input"),l=document.createElement("div"),o=document.createElement("div");t.className=n.CLASS_NAME,r.type="radio",r.name=e.name,r.value=e.color,r.checked=e.checked,r.required=e.required,l.className=n.COLOR_BOX_OUTER_CLASS_NAME,o.className=n.COLOR_BOX_INNER_CLASS_NAME,o.style.backgroundColor=e.color,l.appendChild(o),t.appendChild(r),t.appendChild(l),this.top_elem=t,this.input_elem=r}get checked(){return this.input_elem.checked}get value(){return this.input_elem.value}add_event_listener(e,t){this.input_elem.addEventListener(e,t)}}n.CLASS_NAME="color-button",n.COLOR_BOX_OUTER_CLASS_NAME="color-box-outer",n.COLOR_BOX_INNER_CLASS_NAME="color-box-inner";class _{constructor(e){var t=document.createElement("label"),r=document.createElement("input");t.className=_.CLASS_NAME,t.textContent=e.label,r.type="text",r.name=e.name,null!=e.required&&(r.required=e.required),null!=e.min_length&&(r.minLength=e.min_length),null!=e.max_length&&(r.maxLength=e.max_length),null!=e.pattern&&(r.pattern=e.pattern),null!=e.placeholder&&(r.placeholder=e.placeholder),null!=e.spellcheck&&(r.spellcheck=e.spellcheck),t.appendChild(r),this.top_elem=t,this.name=e.name,this.input_elem=r}get value(){return this.input_elem.value}}_.CLASS_NAME="text-field";